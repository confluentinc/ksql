#!/bin/bash

# (Copyright) [2021 - 2021] Confluent, Inc.

: "${JAVA_HOME:=""}"

function find_java_home {
  local system=$(uname -s)
  if (( $system == "Darwin" )); then
    echo $(/usr/libexec/java_home)
  fi
}

# Which java to use
if [ -z "$JAVA_HOME" ]; then
  JAVA_HOME=$(find_java_home)
fi

if [ -z "$JAVA_HOME" ]; then
  echo "Could not find java home. Please set JAVA_HOME to path to jdk installation directory"
  exit 1
fi

KSQL_CLASSPATH="$JAVA_HOME/lib/*"
JAVA="$JAVA_HOME/bin/java"

base_dir=$( cd -P "$( dirname "${BASH_SOURCE[0]}" )/.." && pwd )

for dir in "$base_dir/ksqldb-tools/target/ksqldb-tools"-*-development; do
  KSQL_DIR="$dir/share/java/ksqldb-tools"
  if [ -d $KSQL_DIR ]; then
    KSQL_CLASSPATH="$KSQL_CLASSPATH:$KSQL_DIR/*"
  fi
done

DIR="$base_dir/share/java/ksqldb"
if [ -d "$DIR" ]; then
  KSQL_CLASSPATH="$DIR/*:$KSQL_CLASSPATH"
fi

: "${KSQL_CONFIG_DIR:="$base_dir/config"}"
: "${KSQL_LOG4J_OPTS:=""}"
if [ -z "$KSQL_LOG4J_OPTS" ]; then
  if [ -e "$base_dir/config/log4j-console.properties" ]; then # Dev environment
    KSQL_CONFIG_DIR="$base_dir/config"
  elif [ -e "$base_dir/etc/ksqldb/log4j-console.properties" ]; then # Simple zip file layout
    KSQL_CONFIG_DIR="$base_dir/etc/ksqldb"
  elif [ -e "/etc/ksqldb/log4j-console.properties" ]; then # Normal install layout
    KSQL_CONFIG_DIR="/etc/ksqldb"
  fi
  export KSQL_LOG4J_OPTS="$KSQL_CONFIG_DIR/log4j-console.properties"
fi

exec "$JAVA" -Dlog4j.configuration=file://"$KSQL_LOG4J_OPTS" -cp "$KSQL_CLASSPATH" io.confluent.ksql.tools.migrations.Migrations "$@"
