{
  "tests": [
    {
      "name": "deserialize anonymous primitive - value",
      "statements": [
        "CREATE STREAM INPUT (K STRING KEY, foo INT) WITH (WRAP_SINGLE_VALUE=false, kafka_topic='input_topic', value_format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "topics": [
        {
          "name": "input_topic",
          "valueSchema": "int"
        }
      ],
      "inputs": [
        {"topic": "input_topic", "value": 10},
        {"topic": "input_topic", "value": null}
      ],
      "outputs": [
        {"topic": "OUTPUT", "value": {"FOO": 10}},
        {"topic": "OUTPUT", "value": null}
      ]
    },
    {
      "name": "deserialize anonymous primitive - value - with coercion",
      "statements": [
        "CREATE STREAM INPUT (K STRING KEY, foo STRING) WITH (WRAP_SINGLE_VALUE=false, kafka_topic='input_topic', value_format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "topics": [
        {
          "name": "input_topic",
          "valueSchema": "int"
        }
      ],
      "inputs": [
        {"topic": "input_topic", "value": 10}
      ],
      "outputs": [
        {"topic": "OUTPUT", "value": {"FOO": "10"}}
      ]
    },
    {
      "name": "deserialize nested primitive - value",
      "statements": [
        "CREATE STREAM INPUT (K STRING KEY, foo INT) WITH (WRAP_SINGLE_VALUE=true, kafka_topic='input_topic', value_format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "inputs": [
        {"topic": "input_topic", "value": {"FOO": 10}},
        {"topic": "input_topic", "value": null}
      ],
      "outputs": [
        {"topic": "OUTPUT", "value": {"FOO": 10}},
        {"topic": "OUTPUT", "value": null}
      ]
    },
    {
      "name": "deserialize anonymous array - value",
      "comments": [
        "see github issue https://github.com/confluentinc/ksql/issues/1351"
      ],
      "statements": [
        "CREATE STREAM INPUT (foo ARRAY<STRING>) WITH (WRAP_SINGLE_VALUE=false, kafka_topic='input_topic', value_format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "topics": [
        {
          "name": "input_topic",
          "valueSchema": {"type": "array", "items": ["null", "string"]}
        }
      ],
      "inputs": [
        {"topic": "input_topic", "value": ["a", "b", "c"]},
        {"topic": "input_topic", "value": ["a", "b", null]},
        {"topic": "input_topic", "value": null}
      ],
      "outputs": [
        {"topic": "OUTPUT", "value": {"FOO": ["a", "b", "c"]}},
        {"topic": "OUTPUT", "value": {"FOO": ["a", "b", null]}},
        {"topic": "OUTPUT", "value": null}
      ]
    },
    {
      "name": "deserialize anonymous array - value - with coercion",
      "statements": [
        "CREATE STREAM INPUT (foo ARRAY<STRING>) WITH (WRAP_SINGLE_VALUE=false, kafka_topic='input_topic', value_format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "topics": [
        {
          "name": "input_topic",
          "valueSchema": {"type": "array", "items": ["null", "string"]}
        }
      ],
      "inputs": [
        {"topic": "input_topic", "value": [1, 2, 3]}
      ],
      "outputs": [
        {"topic": "OUTPUT", "value": {"FOO": ["1", "2", "3"]}}
      ]
    },
    {
      "name": "deserialize nested array - value",
      "statements": [
        "CREATE STREAM INPUT (foo ARRAY<STRING>) WITH (WRAP_SINGLE_VALUE=true, kafka_topic='input_topic', value_format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "inputs": [
        {"topic": "input_topic", "value": {"FOO": ["a", "b", "c"]}},
        {"topic": "input_topic", "value": {"FOO": ["a", "b", null]}},
        {"topic": "input_topic", "value": {"FOO": null}},
        {"topic": "input_topic", "value": null}
      ],
      "outputs": [
        {"topic": "OUTPUT", "value": {"FOO": ["a", "b", "c"]}},
        {"topic": "OUTPUT", "value": {"FOO": ["a", "b", null]}},
        {"topic": "OUTPUT", "value": {"FOO": null}},
        {"topic": "OUTPUT", "value": null}
      ]
    },
    {
      "name": "deserialize anonymous array - value - non-nullable",
      "statements": [
        "CREATE STREAM INPUT (foo ARRAY<STRING>) WITH (WRAP_SINGLE_VALUE=false, kafka_topic='input_topic', value_format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "topics": [
        {
          "name": "input_topic",
          "valueSchema": {"type": "array", "items": "string"},
          "valueFormat": "AVRO"
        }
      ],
      "inputs": [
        {"topic": "input_topic", "value": ["a", "b", "c"]}
      ],
      "outputs": [
        {"topic": "OUTPUT", "value": {"FOO": ["a", "b", "c"]}}
      ]
    },
    {
      "name": "deserialize anonymous map - value",
      "statements": [
        "CREATE STREAM INPUT (foo MAP<STRING, INT>) WITH (WRAP_SINGLE_VALUE=false, kafka_topic='input_topic', value_format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "topics": [
        {
          "name": "input_topic",
          "valueSchema": {"type": "map", "values": ["null", "int"]}
        }
      ],
      "inputs": [
        {"topic": "input_topic", "value": {"a": 1, "b": 2, "c": 3}},
        {"topic": "input_topic", "value": {"a": 1, "b": 2, "c": null}},
        {"topic": "input_topic", "value": null}
      ],
      "outputs": [
        {"topic": "OUTPUT", "value": {"FOO": {"a": 1, "b": 2, "c": 3}}},
        {"topic": "OUTPUT", "value": {"FOO": {"a": 1, "b": 2, "c": null}}},
        {"topic": "OUTPUT", "value": null}
      ],
      "post": {
        "sources": [
          {"name": "INPUT", "type": "stream", "schema": "FOO MAP<STRING, INT>"}
        ]
      }
    },
    {
      "name": "deserialize anonymous map - value - with coercion - AVRO",
      "statements": [
        "CREATE STREAM INPUT (foo MAP<STRING, STRING>) WITH (WRAP_SINGLE_VALUE=false, kafka_topic='input_topic', value_format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "topics": [
        {
          "name": "input_topic",
          "valueSchema": {"type": "map", "values": ["null", "int"]},
          "valueFormat": "AVRO"
        }
      ],
      "inputs": [
        {"topic": "input_topic", "value": {"a": 1, "b": 2, "c": 3}}
      ],
      "outputs": [
        {"topic": "OUTPUT", "value": {"FOO": {"a": "1", "b": "2", "c": "3"}}}
      ],
      "post": {
        "sources": [
          {"name": "INPUT", "type": "stream", "schema": "FOO MAP<STRING, STRING>"}
        ]
      }
    },
    {
      "name": "deserialize anonymous map - value - non-nullable",
      "statements": [
        "CREATE STREAM INPUT (foo MAP<STRING, INT>) WITH (WRAP_SINGLE_VALUE=false, kafka_topic='input_topic', value_format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "topics": [
        {
          "name": "input_topic",
          "valueSchema": {"type": "map", "values": "int"},
          "valueFormat": "AVRO"
        }
      ],
      "inputs": [
        {"topic": "input_topic", "value": {"a": 1, "b": 2, "c": 3}}
      ],
      "outputs": [
        {"topic": "OUTPUT", "value": {"FOO": {"a": 1, "b": 2, "c": 3}}}
      ],
      "post": {
        "sources": [
          {"name": "INPUT", "type": "stream", "schema": "FOO MAP<STRING, INT>"}
        ]
      }
    },
    {
      "name": "serialize anonymous primitive - value",
      "statements": [
        "CREATE STREAM INPUT (K STRING KEY, foo BOOLEAN) WITH (kafka_topic='input_topic', value_format='AVRO');",
        "CREATE STREAM OUTPUT WITH (WRAP_SINGLE_VALUE=false) AS SELECT * FROM INPUT;"
      ],
      "topics": [
        {
          "name": "OUTPUT",
          "valueSchema": "boolean"
        }
      ],
      "inputs": [
        {"topic": "input_topic", "value": {"FOO": true}},
        {"topic": "input_topic", "value": {"FOO": null}},
        {"topic": "input_topic", "value": null}
      ],
      "outputs": [
        {"topic": "OUTPUT", "value": true},
        {"topic": "OUTPUT", "value": null},
        {"topic": "OUTPUT", "value": null}
      ]
    },
    {
      "name": "serialize nested primitive - value",
      "statements": [
        "CREATE STREAM INPUT (K STRING KEY, foo BOOLEAN) WITH (kafka_topic='input_topic', value_format='AVRO');",
        "CREATE STREAM OUTPUT WITH (WRAP_SINGLE_VALUE=true) AS SELECT * FROM INPUT;"
      ],
      "inputs": [
        {"topic": "input_topic", "value": {"FOO": true}},
        {"topic": "input_topic", "value": {"FOO": null}},
        {"topic": "input_topic", "value": null}
      ],
      "outputs": [
        {"topic": "OUTPUT", "value": {"FOO": true}},
        {"topic": "OUTPUT", "value": {"FOO": null}},
        {"topic": "OUTPUT", "value": null}
      ]
    },
    {
      "name": "serialize anonymous array - value",
      "statements": [
        "CREATE STREAM INPUT (foo ARRAY<BIGINT>) WITH (kafka_topic='input_topic', value_format='AVRO');",
        "CREATE STREAM OUTPUT WITH (WRAP_SINGLE_VALUE=false) AS SELECT * FROM INPUT;"
      ],
      "topics": [
        {
          "name": "OUTPUT",
          "valueSchema": {"type": "array", "items": ["null", "long"]}
        }
      ],
      "inputs": [
        {"topic": "input_topic", "value": {"FOO": [12, 34, 999]}},
        {"topic": "input_topic", "value": {"FOO": [12, 34, null]}},
        {"topic": "input_topic", "value": {"FOO": null}},
        {"topic": "input_topic", "value": null}
      ],
      "outputs": [
        {"topic": "OUTPUT", "value": [12, 34, 999]},
        {"topic": "OUTPUT", "value": [12, 34, null]},
        {"topic": "OUTPUT", "value": null},
        {"topic": "OUTPUT", "value": null}
      ]
    },
    {
      "name": "serialize nested array - value",
      "statements": [
        "CREATE STREAM INPUT (foo ARRAY<BIGINT>) WITH (kafka_topic='input_topic', value_format='AVRO');",
        "CREATE STREAM OUTPUT WITH (WRAP_SINGLE_VALUE=true) AS SELECT * FROM INPUT;"
      ],
      "inputs": [
        {"topic": "input_topic", "value": {"FOO": [12, 34, 999]}},
        {"topic": "input_topic", "value": {"FOO": [12, 34, null]}},
        {"topic": "input_topic", "value": {"FOO": null}},
        {"topic": "input_topic", "value": null}
      ],
      "outputs": [
        {"topic": "OUTPUT", "value": {"FOO": [12, 34, 999]}},
        {"topic": "OUTPUT", "value": {"FOO": [12, 34, null]}},
        {"topic": "OUTPUT", "value": {"FOO": null}},
        {"topic": "OUTPUT", "value": null}
      ]
    },
    {
      "name": "serialize anonymous map - value",
      "statements": [
        "CREATE STREAM INPUT (foo MAP<STRING, DOUBLE>) WITH (kafka_topic='input_topic', value_format='AVRO');",
        "CREATE STREAM OUTPUT WITH (WRAP_SINGLE_VALUE=false) AS SELECT * FROM INPUT;"
      ],
      "topics": [
        {
          "name": "OUTPUT",
          "valueSchema": {"type":"array","items":{"type":"record","name":"test","fields":[{"name":"key","type":["null","string"],"default":null},{"name":"value","type":["null","double"],"default":null}]}}
        }
      ],
      "inputs": [
        {"topic": "input_topic", "value": {"FOO": {"a": 1.1, "b": 2.2, "c": 3.456}}},
        {"topic": "input_topic", "value": {"FOO": {"a": 1.1, "b": 2.2, "c": null}}},
        {"topic": "input_topic", "value": {"FOO": null}},
        {"topic": "input_topic", "value": null}
      ],
      "outputs": [
        {"topic": "OUTPUT", "value": {"a": 1.1, "b": 2.2, "c": 3.456}},
        {"topic": "OUTPUT", "value": {"a": 1.1, "b": 2.2, "c": null}},
        {"topic": "OUTPUT", "value": null},
        {"topic": "OUTPUT", "value": null}
      ]
    },
    {
      "name": "serialize nested map - value",
      "statements": [
        "CREATE STREAM INPUT (foo MAP<STRING, DOUBLE>) WITH (kafka_topic='input_topic', value_format='AVRO');",
        "CREATE STREAM OUTPUT WITH (WRAP_SINGLE_VALUE=true) AS SELECT * FROM INPUT;"
      ],
      "inputs": [
        {"topic": "input_topic", "value": {"FOO": {"a": 1.1, "b": 2.2, "c": 3.456}}},
        {"topic": "input_topic", "value": {"FOO": {"a": 1.1, "b": 2.2, "c": null}}},
        {"topic": "input_topic", "value": {"FOO": null}},
        {"topic": "input_topic", "value": null}
      ],
      "outputs": [
        {"topic": "OUTPUT", "value": {"FOO": {"a": 1.1, "b": 2.2, "c": 3.456}}},
        {"topic": "OUTPUT", "value": {"FOO": {"a": 1.1, "b": 2.2, "c": null}}},
        {"topic": "OUTPUT", "value": {"FOO": null}},
        {"topic": "OUTPUT", "value": null}
      ]
    },
    {
      "name": "deserialize anonymous struct - value - no inference",
      "statements": [
        "CREATE STREAM INPUT (foo STRUCT<F0 INT>) WITH (kafka_topic='input_topic', value_format='AVRO', wrap_single_value=false);",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "inputs": [
        {"topic": "input_topic", "value": {"F0": 1}},
        {"topic": "input_topic", "value": {"F0": null}},
        {"topic": "input_topic", "value": null}
      ],
      "outputs": [
        {"topic": "OUTPUT", "value": {"FOO": {"F0": 1}}},
        {"topic": "OUTPUT", "value": {"FOO": {"F0": null}}},
        {"topic": "OUTPUT", "value": null}
      ]
    },
    {
      "name": "deserialize anonymous struct - value - inference",
      "statements": [
        "CREATE STREAM INPUT WITH (kafka_topic='input_topic', value_format='AVRO', wrap_single_value=false);",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "topics": [
        {
          "name": "input_topic",
          "valueSchema": {"type": "record", "name": "most_recent_value_schema_at_SR", "fields": [{"name": "F0", "type": ["null", "int"]}]}
        }
      ],
      "inputs": [
        {"topic": "input_topic", "value": {"F0": 1}},
        {"topic": "input_topic", "value": {"F0": null}},
        {"topic": "input_topic", "value": null}
      ],
      "outputs": [
        {"topic": "OUTPUT", "value": {"ROWVAL": {"F0": 1}}},
        {"topic": "OUTPUT", "value": {"ROWVAL": {"F0": null}}},
        {"topic": "OUTPUT", "value": null}
      ]
    },
    {
      "name": "serialize anonymous struct - value",
      "statements": [
        "CREATE STREAM INPUT (foo STRUCT<F0 INT>) WITH (kafka_topic='input_topic', value_format='AVRO');",
        "CREATE STREAM OUTPUT WITH (WRAP_SINGLE_VALUE=false) AS SELECT * FROM INPUT;"
      ],
      "inputs": [
        {"topic": "input_topic", "value": {"FOO": {"F0": 1}}},
        {"topic": "input_topic", "value": {"FOO": {"F0": null}}},
        {"topic": "input_topic", "value": {"FOO": null}},
        {"topic": "input_topic", "value": null}
      ],
      "outputs": [
        {"topic": "OUTPUT", "value": {"F0": 1}},
        {"topic": "OUTPUT", "value": {"F0": null}},
        {"topic": "OUTPUT", "value": null},
        {"topic": "OUTPUT", "value": null}
      ]
    },
    {
      "name": "serialize nested struct - value",
      "statements": [
        "CREATE STREAM INPUT (foo STRUCT<F0 INT>) WITH (kafka_topic='input_topic', value_format='AVRO');",
        "CREATE STREAM OUTPUT WITH (WRAP_SINGLE_VALUE=true) AS SELECT * FROM INPUT;"
      ],
      "inputs": [
        {"topic": "input_topic", "value": {"FOO": {"F0": 1}}},
        {"topic": "input_topic", "value": {"FOO": {"F0": null}}},
        {"topic": "input_topic", "value": {"FOO": null}},
        {"topic": "input_topic", "value": null}
      ],
      "outputs": [
        {"topic": "OUTPUT", "value": {"FOO": {"F0": 1}}},
        {"topic": "OUTPUT", "value": {"FOO": {"F0": null}}},
        {"topic": "OUTPUT", "value": {"FOO": null}},
        {"topic": "OUTPUT", "value": null}
      ]
    },
    {
      "name": "should support primitives",
      "statements": [
        "CREATE STREAM INPUT WITH (kafka_topic='input', value_format='AvRo');",
        "CREATE STREAM OUTPUT AS SELECT * FROM input;"
      ],
      "topics": [
        {
          "name": "input",
          "valueFormat": "AVRO",
          "valueSchema": {"name": "blah", "type": "record", "fields": [
            {"name": "c1", "type": "boolean"},
            {"name": "c2", "type": "int"},
            {"name": "c3", "type": "long"},
            {"name": "c4", "type": "double"},
            {"name": "c5", "type": "string"}
          ]}
        }
      ],
      "inputs": [{"topic": "input", "value": {"c1": true, "c2": 1, "c3": 400000000000, "c4": 1.284765648, "c5": "hello"}}],
      "outputs": [{"topic": "OUTPUT", "value": {"C1": true, "C2": 1, "C3": 400000000000, "C4": 1.284765648, "C5": "hello"}}],
      "post": {
        "sources": [
          {"name": "OUTPUT", "type": "stream", "schema": "C1 BOOLEAN, C2 INT, C3 BIGINT, C4 DOUBLE, C5 STRING"}
        ]
      }
    },
    {
      "name": "should convert enum to STRING",
      "statements": [
        "CREATE STREAM INPUT WITH (kafka_topic='input', value_format='AvRo');",
        "CREATE STREAM OUTPUT AS SELECT * FROM input;"
      ],
      "topics": [
        {
          "name": "input",
          "valueFormat": "AVRO",
          "valueSchema": {"name": "blah", "type": "record", "fields": [
            {"name": "c1", "type": { "type": "enum",
              "name": "Suit",
              "symbols" : ["SPADES", "HEARTS", "DIAMONDS", "CLUBS"]
            }}
          ]}
        }
      ],
      "inputs": [{"topic": "input", "value": {"c1": "SPADES"}}],
      "outputs": [{"topic": "OUTPUT", "value": {"C1": "SPADES"}}],
      "post": {
        "sources": [
          {"name": "OUTPUT", "type": "stream", "schema": "C1 STRING"}
        ]
      }
    },
    {
      "name": "should support arrays",
      "statements": [
        "CREATE STREAM INPUT WITH (kafka_topic='input', value_format='AvRo');",
        "CREATE STREAM OUTPUT AS SELECT * FROM input;"
      ],
      "topics": [
        {
          "name": "input",
          "valueFormat": "AVRO",
          "valueSchema": {"name": "blah", "type": "record", "fields": [
            {"name": "c1", "type": {"type": "array", "items": "string"}}
          ]}
        }
      ],
      "inputs": [{"topic": "input", "value": {"c1": ["a", "", "Bc"]}}],
      "outputs": [{"topic": "OUTPUT", "value": {"C1": ["a", "", "Bc"]}}],
      "post": {
        "sources": [
          {"name": "OUTPUT", "type": "stream", "schema": "C1 ARRAY<STRING>"}
        ]
      }
    },
    {
      "name": "should support maps",
      "statements": [
        "CREATE STREAM INPUT WITH (kafka_topic='input', value_format='AvRo');",
        "CREATE STREAM OUTPUT AS SELECT * FROM input;"
      ],
      "topics": [
        {
          "name": "input",
          "valueFormat": "AVRO",
          "valueSchema": {"name": "blah", "type": "record", "fields": [
            {"name": "c1", "type": {"type": "map", "values": "long"}}
          ]}
        }
      ],
      "inputs": [{"topic": "input", "value": {"c1": {"f1": 1}}}],
      "outputs": [{"topic": "OUTPUT", "value": {"C1": {"f1":  1}}}],
      "post": {
        "sources": [
          {"name": "OUTPUT", "type": "stream", "schema": "C1 MAP<STRING, BIGINT>"}
        ]
      }
    },
    {
      "name": "should convert record to STRUCT",
      "statements": [
        "CREATE STREAM INPUT WITH (kafka_topic='input', value_format='AvRo');",
        "CREATE STREAM OUTPUT AS SELECT * FROM input;"
      ],
      "topics": [
        {
          "name": "input",
          "valueFormat": "AVRO",
          "valueSchema": {"name": "blah", "type": "record", "fields": [
            {"name": "c1", "type": { "type": "record",
              "name": "something",
              "fields": [
                {"name": "f1", "type": "int"}
              ]
            }}
          ]}
        }
      ],
      "inputs": [{"topic": "input", "value": {"c1": {"f1": 1}}}],
      "outputs": [{"topic": "OUTPUT", "value": {"C1": {"F1":  1}}}],
      "post": {
        "sources": [
          {"name": "OUTPUT", "type": "stream", "schema": "C1 STRUCT<F1 INT>"}
        ]
      }
    },{
      "name": "should coerce column types that are not directly supported",
      "statements": [
        "CREATE STREAM INPUT WITH (kafka_topic='input', value_format='AvRo');",
        "CREATE STREAM OUTPUT AS SELECT * FROM input;"
      ],
      "topics": [
        {
          "name": "input",
          "valueFormat": "AVRO",
          "valueSchema": {"name": "blah", "type": "record", "fields": [
            {"name": "c1", "type": "float"}
          ]}
        },
        {
          "name": "OUTPUT"
        }
      ],
      "inputs": [{"topic": "input", "value": {"c1": 4.0}}],
      "outputs": [{"topic": "OUTPUT", "value": {"C1": 4.0}}],
      "post": {
        "sources": [
          {"name": "OUTPUT", "type": "stream", "schema": "C1 DOUBLE"}
        ]
      }
    },
    {
      "name": "should filter out columns with unsupported types",
      "statements": [
        "CREATE STREAM INPUT WITH (kafka_topic='input', value_format='AvRo');",
        "CREATE STREAM OUTPUT AS SELECT * FROM input;"
      ],
      "topics": [
        {
          "name": "input",
          "valueFormat": "AVRO",
          "valueSchema": {"name": "blah", "type": "record", "fields": [
            {"name": "expected", "type": "int"},
            {"name": "c1", "type": ["null","bytes"]},
            {"name": "c2", "type": ["null", {"type": "fixed", "size": 16, "name": "md5"}]}
          ]}
        }
      ],
      "inputs": [{"topic": "input", "value": {"expected": 1, "c2": null, "c3": null}}],
      "outputs": [{"topic": "OUTPUT", "value": {"EXPECTED": 1}}],
      "post": {
        "sources": [
          {"name": "OUTPUT", "type": "stream", "schema": "EXPECTED INT"}
        ]
      }
    },
    {
      "name": "should support partial schemas",
      "statements": [
        "CREATE STREAM INPUT (ID INT KEY) WITH (kafka_topic='input', value_format='AvRo');",
        "CREATE STREAM OUTPUT AS SELECT * FROM input;"
      ],
      "topics": [
        {
          "name": "input",
          "valueFormat": "AVRO",
          "valueSchema": {"name": "blah", "type": "record", "fields": [
            {"name": "c1", "type": "boolean"},
            {"name": "c2", "type": "int"},
            {"name": "c3", "type": "long"},
            {"name": "c4", "type": "double"},
            {"name": "c5", "type": "string"}
          ]}
        }
      ],
      "inputs": [{"topic": "input", "key": 1, "value": {"c1": true, "c2": 1, "c3": 400000000000, "c4": 1.284765648, "c5": "hello"}}],
      "outputs": [{"topic": "OUTPUT", "key": 1, "value": {"C1": true, "C2": 1, "C3": 400000000000, "C4": 1.284765648, "C5": "hello"}}],
      "post": {
        "sources": [
          {"name": "OUTPUT", "type": "stream", "schema": "ID INT KEY, C1 BOOLEAN, C2 INT, C3 BIGINT, C4 DOUBLE, C5 STRING"}
        ]
      }
    },
    {
      "name": "BOOLEAN - key - no inference",
      "statements": [
        "CREATE STREAM INPUT (K BOOLEAN KEY, foo INT) WITH (kafka_topic='input_topic', format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "inputs": [
        {"topic": "input_topic", "key": true, "value": {"FOO": 10}},
        {"topic": "input_topic", "value": null}
      ],
      "outputs": [
        {"topic": "OUTPUT", "key": true, "value": {"FOO": 10}},
        {"topic": "OUTPUT", "value": null}
      ]
    },
    {
      "name": "BOOLEAN - key - inference",
      "statements": [
        "CREATE STREAM INPUT (foo INT) WITH (kafka_topic='input_topic', format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "topics": [
        {
          "name": "input_topic",
          "keySchema": {"type": "boolean"},
          "keyFormat": "AVRO"
        }
      ],
      "inputs": [
        {"topic": "input_topic", "key": true, "value": {"FOO": 10}},
        {"topic": "input_topic", "value": null}
      ],
      "outputs": [
        {"topic": "OUTPUT", "key": true, "value": {"FOO": 10}},
        {"topic": "OUTPUT", "value": null}
      ]
    },
    {
      "name": "INT - key - no inference",
      "statements": [
        "CREATE STREAM INPUT (K INT KEY, foo INT) WITH (kafka_topic='input_topic', format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "inputs": [
        {"topic": "input_topic", "key": 10, "value": {"FOO": 10}},
        {"topic": "input_topic", "key": 12, "value": {"FOO": 10}},
        {"topic": "input_topic", "key": null, "value": {"FOO": 10}}
      ],
      "outputs": [
        {"topic": "OUTPUT", "key": 10, "value": {"FOO": 10}},
        {"topic": "OUTPUT", "key": 12, "value": {"FOO": 10}},
        {"topic": "OUTPUT", "key": null, "value": {"FOO": 10}}
      ]
    },
    {
      "name": "INT - key - inference",
      "statements": [
        "CREATE STREAM INPUT (foo INT) WITH (kafka_topic='input_topic', format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "topics": [
        {
          "name": "input_topic",
          "keySchema": {"type": "int"},
          "keyFormat": "AVRO"
        }
      ],
      "inputs": [
        {"topic": "input_topic", "key": 10, "value": {"FOO": 10}},
        {"topic": "input_topic", "key": 12, "value": {"FOO": 10}},
        {"topic": "input_topic", "key": null, "value": {"FOO": 10}}
      ],
      "outputs": [
        {"topic": "OUTPUT", "key": 10, "value": {"FOO": 10}},
        {"topic": "OUTPUT", "key": 12, "value": {"FOO": 10}},
        {"topic": "OUTPUT", "key": null, "value": {"FOO": 10}}
      ]
    },
    {
      "name": "BIGINT - key - no inference",
      "statements": [
        "CREATE STREAM INPUT (K BIGINT KEY, foo INT) WITH (kafka_topic='input_topic', format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "inputs": [
        {"topic": "input_topic", "key": 998877665544332211, "value": {"FOO": 10}},
        {"topic": "input_topic", "key": null, "value": {"FOO": 10}}
      ],
      "outputs": [
        {"topic": "OUTPUT", "key": 998877665544332211, "value": {"FOO": 10}},
        {"topic": "OUTPUT", "key": null, "value": {"FOO": 10}}
      ]
    },
    {
      "name": "BIGINT - key - inference",
      "statements": [
        "CREATE STREAM INPUT (foo INT) WITH (kafka_topic='input_topic', format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "topics": [
        {
          "name": "input_topic",
          "keySchema": {"type": "long"},
          "keyFormat": "AVRO"
        }
      ],
      "inputs": [
        {"topic": "input_topic", "key": 998877665544332211, "value": {"FOO": 10}},
        {"topic": "input_topic", "key": null, "value": {"FOO": 10}}
      ],
      "outputs": [
        {"topic": "OUTPUT", "key": 998877665544332211, "value": {"FOO": 10}},
        {"topic": "OUTPUT", "key": null, "value": {"FOO": 10}}
      ]
    },
    {
      "name": "DOUBLE - key - no inference",
      "statements": [
        "CREATE STREAM INPUT (K DOUBLE KEY, foo INT) WITH (kafka_topic='input_topic', format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "inputs": [
        {"topic": "input_topic", "key": 654.321, "value": {"FOO": 10}},
        {"topic": "input_topic", "key": null, "value": {"FOO": 10}}
      ],
      "outputs": [
        {"topic": "OUTPUT", "key": 654.321, "value": {"FOO": 10}},
        {"topic": "OUTPUT", "key": null, "value": {"FOO": 10}}
      ]
    },
    {
      "name": "DOUBLE - key - inference",
      "statements": [
        "CREATE STREAM INPUT (foo INT) WITH (kafka_topic='input_topic', format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "topics": [
        {
          "name": "input_topic",
          "keySchema": {"type": "double"},
          "keyFormat": "AVRO"
        }
      ],
      "inputs": [
        {"topic": "input_topic", "key": 654.321, "value": {"FOO": 10}},
        {"topic": "input_topic", "key": null, "value": {"FOO": 10}}
      ],
      "outputs": [
        {"topic": "OUTPUT", "key": 654.321, "value": {"FOO": 10}},
        {"topic": "OUTPUT", "key": null, "value": {"FOO": 10}}
      ]
    },
    {
      "name": "STRING - key - no inference",
      "statements": [
        "CREATE STREAM INPUT (K VARCHAR KEY, foo INT) WITH (kafka_topic='input_topic', format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "inputs": [
        {"topic": "input_topic", "key": "foo", "value": {"FOO": 10}},
        {"topic": "input_topic", "key": null, "value": {"FOO": 10}}
      ],
      "outputs": [
        {"topic": "OUTPUT", "key": "foo", "value": {"FOO": 10}},
        {"topic": "OUTPUT", "key": null, "value": {"FOO": 10}}
      ]
    },
    {
      "name": "STRING - key - inference",
      "statements": [
        "CREATE STREAM INPUT (foo INT) WITH (kafka_topic='input_topic', format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "topics": [
        {
          "name": "input_topic",
          "keySchema": {"type": "string"},
          "keyFormat": "AVRO"
        }
      ],
      "inputs": [
        {"topic": "input_topic", "key": "foo", "value": {"FOO": 10}},
        {"topic": "input_topic", "key": null, "value": {"FOO": 10}}
      ],
      "outputs": [
        {"topic": "OUTPUT", "key": "foo", "value": {"FOO": 10}},
        {"topic": "OUTPUT", "key": null, "value": {"FOO": 10}}
      ]
    },
    {
      "name": "DECIMAL - key - no inference",
      "statements": [
        "CREATE STREAM INPUT (K DECIMAL(4,2) KEY, foo INT) WITH (kafka_topic='input_topic', format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "inputs": [
        {"topic": "input_topic", "key": 65.21, "value": {"FOO": 10}},
        {"topic": "input_topic", "key": null, "value": {"FOO": 10}}
      ],
      "outputs": [
        {"topic": "OUTPUT", "key": 65.21, "value": {"FOO": 10}},
        {"topic": "OUTPUT", "key": null, "value": {"FOO": 10}}
      ]
    },
    {
      "name": "DECIMAL - key - inference",
      "statements": [
        "CREATE STREAM INPUT (foo INT) WITH (kafka_topic='input_topic', format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "topics": [
        {
          "name": "input_topic",
          "keySchema": {
            "type": "bytes",
            "logicalType": "decimal",
            "precision": 4,
            "scale": 2
          }
        }
      ],
      "inputs": [
        {"topic": "input_topic", "key": 65.21, "value": {"FOO": 10}},
        {"topic": "input_topic", "key": null, "value": {"FOO": 10}}
      ],
      "outputs": [
        {"topic": "OUTPUT", "key": 65.21, "value": {"FOO": 10}},
        {"topic": "OUTPUT", "key": null, "value": {"FOO": 10}}
      ]
    },
    {
      "name": "ARRAY - key - no inference",
      "statements": [
        "CREATE STREAM INPUT (K ARRAY<VARCHAR> KEY, foo INT) WITH (kafka_topic='input_topic', format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "inputs": [
        {"topic": "input_topic", "key": ["foo"], "value": {"FOO": 10}},
        {"topic": "input_topic", "key": [null], "value": {"FOO": 10}},
        {"topic": "input_topic", "key": null, "value": {"FOO": 10}}
      ],
      "outputs": [
        {"topic": "OUTPUT", "key": ["foo"], "value": {"FOO": 10}},
        {"topic": "OUTPUT", "key": [null], "value": {"FOO": 10}},
        {"topic": "OUTPUT", "key": null, "value": {"FOO": 10}}
      ]
    },
    {
      "name": "ARRAY - key - inference",
      "statements": [
        "CREATE STREAM INPUT (foo INT) WITH (kafka_topic='input_topic', format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "topics": [
        {
          "name": "input_topic",
          "keySchema": {"type": "array", "items": ["null", "string"]},
          "keyFormat": "AVRO"

        }
      ],
      "inputs": [
        {"topic": "input_topic", "key": ["foo"], "value": {"FOO": 10}},
        {"topic": "input_topic", "key": [null], "value": {"FOO": 10}},
        {"topic": "input_topic", "key": null, "value": {"FOO": 10}}
      ],
      "outputs": [
        {"topic": "OUTPUT", "key": ["foo"], "value": {"FOO": 10}},
        {"topic": "OUTPUT", "key": [null], "value": {"FOO": 10}},
        {"topic": "OUTPUT", "key": null, "value": {"FOO": 10}}
      ]
    },
    {
      "name": "MAP - key - C*",
      "statements": [
        "CREATE STREAM INPUT (K MAP<INT, DOUBLE> KEY, foo INT) WITH (kafka_topic='input_topic', format='AVRO');"
      ],
      "expectedException": {
        "type": "io.confluent.ksql.util.KsqlStatementException",
        "message": "Map keys, including types that contain maps, are not supported as they may lead to unexpected behavior due to inconsistent serialization. Key column name: `K`. Column type: MAP<INTEGER, DOUBLE>. See https://github.com/confluentinc/ksql/issues/6621 for more."
      }
    },
    {
      "name": "nested MAP type - key - C*",
      "statements": [
        "CREATE STREAM INPUT (K ARRAY<MAP<INT, DOUBLE>> KEY, foo INT) WITH (kafka_topic='input_topic', format='AVRO');"
      ],
      "expectedException": {
        "type": "io.confluent.ksql.util.KsqlStatementException",
        "message": "Map keys, including types that contain maps, are not supported as they may lead to unexpected behavior due to inconsistent serialization. Key column name: `K`. Column type: ARRAY<MAP<INTEGER, DOUBLE>>. See https://github.com/confluentinc/ksql/issues/6621 for more."
      }
    },
    {
      "name": "MAP - key - C*AS",
      "statements": [
        "CREATE STREAM INPUT (k STRING KEY, v STRING) WITH (kafka_topic='input_topic', format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT PARTITION BY MAP(k:=v);"
      ],
      "expectedException": {
        "type": "io.confluent.ksql.util.KsqlStatementException",
        "message": "Map keys, including types that contain maps, are not supported as they may lead to unexpected behavior due to inconsistent serialization. Key column name: `KSQL_COL_0`. Column type: MAP<STRING, STRING>. See https://github.com/confluentinc/ksql/issues/6621 for more."
      }
    },
    {
      "name": "nested MAP type - key - C*AS",
      "statements": [
        "CREATE STREAM INPUT (k STRING KEY, v STRING) WITH (kafka_topic='input_topic', format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT PARTITION BY STRUCT(f := MAP(k:=v));"
      ],
      "expectedException": {
        "type": "io.confluent.ksql.util.KsqlStatementException",
        "message": "Map keys, including types that contain maps, are not supported as they may lead to unexpected behavior due to inconsistent serialization. Key column name: `KSQL_COL_0`. Column type: STRUCT<`F` MAP<STRING, STRING>>. See https://github.com/confluentinc/ksql/issues/6621 for more."
      }
    },
    {
      "name": "STRUCT - key - no inference",
      "statements": [
        "CREATE STREAM INPUT (K STRUCT<F1 VARCHAR> KEY, foo INT) WITH (kafka_topic='input_topic', format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "inputs": [
        {"topic": "input_topic", "key": {"F1": "foo"}, "value": {"FOO": 10}},
        {"topic": "input_topic", "key": {"F1": null}, "value": {"FOO": 10}},
        {"topic": "input_topic", "key": null, "value": {"FOO": 10}}
      ],
      "outputs": [
        {"topic": "OUTPUT", "key": {"F1": "foo"}, "value": {"FOO": 10}},
        {"topic": "OUTPUT", "key": {"F1": null}, "value": {"FOO": 10}},
        {"topic": "OUTPUT", "key": null, "value": {"FOO": 10}}
      ]
    },
    {
      "name": "STRUCT - key - inference",
      "topics": [
        {
          "name": "input_topic",
          "keySchema": {"name": "key", "type": "record", "fields": [{"name": "F1", "type": ["null", "string"]}]},
          "keyFormat": "AVRO"
        }
      ],
      "statements": [
        "CREATE STREAM INPUT (foo INT) WITH (kafka_topic='input_topic', format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "inputs": [
        {"topic": "input_topic", "key": {"F1": "foo"}, "value": {"FOO": 10}},
        {"topic": "input_topic", "key": {"F1": null}, "value": {"FOO": 10}},
        {"topic": "input_topic", "key": null, "value": {"FOO": 10}}
      ],
      "outputs": [
        {"topic": "OUTPUT", "key": {"F1": "foo"}, "value": {"FOO": 10}},
        {"topic": "OUTPUT", "key": {"F1": null}, "value": {"FOO": 10}},
        {"topic": "OUTPUT", "key": null, "value": {"FOO": 10}}
      ],
      "post": {
        "topics": {
          "topics": [
            {
              "name": "OUTPUT",
              "keyFormat" : { "format" : "AVRO", "features": ["UNWRAP_SINGLES"], "properties": {"fullSchemaName": "io.confluent.ksql.avro_schemas.OutputKey"} },
              "keySchema": {
                "type": "record",
                "name": "OutputKey",
                "namespace": "io.confluent.ksql.avro_schemas",
                "fields": [
                  { "name": "F1", "type": [ "null", "string" ], "default": null }
                ]
              },
              "valueFormat" : { "format" : "AVRO" },
              "valueSchema": {
                "type": "record",
                "name": "KsqlDataSourceSchema",
                "namespace": "io.confluent.ksql.avro_schemas",
                "fields": [
                  { "name": "FOO", "type": [ "null", "int" ], "default": null }
                ]
              }
            }
          ]
        }
      }
    },
    {
      "name": "INT - key - key and value inference",
      "statements": [
        "CREATE STREAM INPUT WITH (kafka_topic='input_topic', format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "topics": [
        {
          "name": "input_topic",
          "keySchema": {"type": "int"},
          "keyFormat": "AVRO",
          "valueSchema": {"name": "most_recent_value_schema_at_SR", "type": "record", "fields": [{"name": "FOO", "type": "int"}]},
          "valueFormat": "AVRO"
        }
      ],
      "inputs": [
        {"topic": "input_topic", "key": 10, "value": {"FOO": 10}},
        {"topic": "input_topic", "key": 12, "value": {"FOO": 10}},
        {"topic": "input_topic", "key": null, "value": {"FOO": 10}}
      ],
      "outputs": [
        {"topic": "OUTPUT", "key": 10, "value": {"FOO": 10}},
        {"topic": "OUTPUT", "key": 12, "value": {"FOO": 10}},
        {"topic": "OUTPUT", "key": null, "value": {"FOO": 10}}
      ]
    },
    {
      "name": "INT - key - key and anonymous value inference",
      "statements": [
        "CREATE STREAM INPUT WITH (kafka_topic='input_topic', format='AVRO', wrap_single_value=false);",
        "CREATE STREAM OUTPUT AS SELECT * FROM INPUT;"
      ],
      "topics": [
        {
          "name": "input_topic",
          "keySchema": {"type": "int"},
          "keyFormat": "AVRO",
          "valueSchema": {"type": "int"},
          "valueFormat": "AVRO"
        }
      ],
      "inputs": [
        {"topic": "input_topic", "key": 10, "value": 10},
        {"topic": "input_topic", "key": 12, "value": null},
        {"topic": "input_topic", "key": null, "value": 10}
      ],
      "outputs": [
        {"topic": "OUTPUT", "key": 10, "value": {"ROWVAL": 10}},
        {"topic": "OUTPUT", "key": 12, "value": null},
        {"topic": "OUTPUT", "key": null, "value": {"ROWVAL": 10}}
      ]
    },
    {
      "name": "map with non-string keys fails - value - C*",
      "statements": [
        "CREATE STREAM INPUT (foo MAP<INT, DOUBLE>) WITH (kafka_topic='input_topic', value_format='AVRO');"
      ],
      "expectedException": {
        "type": "io.confluent.ksql.util.KsqlStatementException",
        "message": "Avro only supports MAPs with STRING keys"
      }
    },
    {
      "name": "map with non-string keys fails - value - C*AS",
      "statements": [
        "CREATE STREAM INPUT (k INT, v DOUBLE) WITH (kafka_topic='input_topic', value_format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT MAP(k:=v) FROM INPUT;"
      ],
      "expectedException": {
        "type": "io.confluent.ksql.util.KsqlStatementException",
        "message": "Avro only supports MAPs with STRING keys"
      }
    },
    {
      "name": "should return error on field names incompatible with avro - C*",
      "statements": [
        "CREATE STREAM INPUT (`1AvroDoesNotLikeFieldsThatStartWithNumbers` DOUBLE) WITH (kafka_topic='input_topic', value_format='AVRO');"
      ],
      "topics": [
        {
          "name": "input_topic",
          "valueFormat": "AVRO"
        }
      ],
      "expectedException": {
        "type": "io.confluent.ksql.util.KsqlStatementException",
        "message": "Schema is not compatible with Avro: Illegal initial character: 1AvroDoesNotLikeFieldsThatStartWithNumbers"
      }
    },
    {
      "name": "should return error on field names incompatible with avro - C*AS",
      "statements": [
        "CREATE STREAM INPUT (v DOUBLE) WITH (kafka_topic='input_topic', value_format='AVRO');",
        "CREATE STREAM OUTPUT AS SELECT v AS `1AvroDoesNotLikeFieldsThatStartWithNumbers` FROM INPUT;"
      ],
      "expectedException": {
        "type": "io.confluent.ksql.util.KsqlStatementException",
        "message": "Schema is not compatible with Avro: Illegal initial character: 1AvroDoesNotLikeFieldsThatStartWithNumbers"
      }
    },
    {
      "name": "empty full schema name",
      "statements": [
        "CREATE STREAM INPUT (K STRING KEY, foo STRING) WITH (kafka_topic='input_topic', value_format='AVRO', VALUE_AVRO_SCHEMA_FULL_NAME=' ');"
      ],
      "expectedException": {
        "type": "io.confluent.ksql.util.KsqlStatementException",
        "message": "fullSchemaName cannot be empty. Format configuration: {fullSchemaName=}"
      }
    },
    {
      "name": "full schema name used with non-Avro format",
      "statements": [
        "CREATE STREAM INPUT (K STRING KEY, foo STRING) WITH (kafka_topic='input_topic', value_format='JSON', VALUE_AVRO_SCHEMA_FULL_NAME='com.custom.schema');"
      ],
      "expectedException": {
        "type": "io.confluent.ksql.util.KsqlStatementException",
        "message": "JSON does not support the following configs: [fullSchemaName]"
      }
    }
  ]
}
